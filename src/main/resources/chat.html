<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI流式聊天助手</title>
    <!-- 引入必要的外部库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            padding: 20px;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chat-header {
            background: #2563eb;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 15px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .user-message {
            background: #2563eb;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background: #e5e7eb;
            color: #111827;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            resize: none;
            min-height: 50px;
            max-height: 200px;
        }

        #messageInput:focus {
            border-color: #2563eb;
        }

        button {
            margin-left: 10px;
            padding: 12px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        button:hover:enabled {
            background: #1d4ed8;
        }

        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .markdown-hint {
            padding: 0 20px 10px;
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Markdown样式支持 */
        .message h1, .message h2, .message h3 {
            margin: 10px 0 5px;
            font-size: 1.2em;
        }

        .message ul, .message ol {
            margin: 5px 0 5px 20px;
        }

        .message code {
            background: rgba(0,0,0,0.1);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }

        .message pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message a {
            color: #93c5fd;
            text-decoration: underline;
        }

        .user-message a {
            color: #bfdbfe;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #64748b;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">AI流式聊天助手</div>
    <div class="messages" id="messages"></div>
    <div class="markdown-hint">支持Markdown格式：**粗体**、*斜体*、`代码`、```代码块```</div>
    <div class="input-area">
        <textarea id="messageInput" placeholder="请输入问题..."></textarea>
        <button onclick="sendMessage()" id="sendBtn">发送</button>
    </div>
</div>

<script>
    // 状态变量
    let isStreaming = false;
    let lastResponseContent = ''; // 用于检测重复回复

    // 初始化Marked解析器
    function initMarked() {
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                highlight: function(code, lang) {
                    if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return code;
                },
                breaks: true,  // 确保\n能被识别为换行
                gfm: true
            });
            return true;
        }
        return false;
    }

    // 页面加载完成后初始化
    window.addEventListener('load', initMarked);

    // 添加用户消息到聊天窗口
    function addUserMessage(text) {
        if (!text || text.trim() === '' || text.trim() === 'null') return;

        const messages = document.getElementById('messages');
        const msgEl = document.createElement('div');
        msgEl.className = 'message user-message';

        // 处理消息内容
        if (initMarked()) {
            msgEl.innerHTML = marked.parse(text);
        } else {
            msgEl.textContent = text;
            msgEl.style.whiteSpace = 'pre-wrap';
        }

        messages.appendChild(msgEl);
        scrollToBottom();
    }

    // 创建AI消息容器
    function createAiMessage() {
        const messages = document.getElementById('messages');
        const msgEl = document.createElement('div');
        msgEl.className = 'message ai-message';

        // 添加打字指示器
        const typingEl = document.createElement('div');
        typingEl.className = 'typing-indicator';
        typingEl.innerHTML = '<span></span><span></span><span></span>';
        msgEl.appendChild(typingEl);

        messages.appendChild(msgEl);
        scrollToBottom();
        return msgEl;
    }

    // 更新AI消息内容
    function updateAiMessage(msgEl, content) {
        // 处理空值和无效内容
        if (!content || content.trim() === 'null') content = '';

        // 移除打字指示器
        const typingEl = msgEl.querySelector('.typing-indicator');
        if (typingEl) {
            msgEl.removeChild(typingEl);
        }

        // 处理内容和换行
        if (initMarked()) {
            // 确保换行符被正确处理
            const processedContent = content.replace(/\n/g, '\n\n');
            msgEl.innerHTML = marked.parse(processedContent);
        } else {
            msgEl.textContent = content;
            msgEl.style.whiteSpace = 'pre-wrap'; // 确保换行生效
        }

        scrollToBottom();
    }

    // 滚动到最新消息
    function scrollToBottom() {
        const messages = document.getElementById('messages');
        messages.scrollTop = messages.scrollHeight;
    }

    // 处理data:前缀和清理内容
    function cleanChunk(chunk) {
        // 1. 移除所有可能的data:前缀（包括带空格的情况）
        let cleaned = chunk.replace(/^data:\s*/gm, '');

        // 2. 移除null字符串
        cleaned = cleaned.replace(/null/g, '');

        // 3. 处理空行和多余的换行符
        cleaned = cleaned.replace(/^\s*$/gm, ''); // 移除空行
        cleaned = cleaned.replace(/\n+/g, '\n');   // 合并多个换行

        // 4. 处理引号问题
        cleaned = cleaned.replace(/""/g, '"');     // 合并重复引号
        cleaned = cleaned.replace(/^"/, '').replace(/"$/, ''); // 移除首尾引号

        return cleaned.trim();
    }

    // 检测并移除重复内容
    function removeDuplicates(newContent) {
        // 如果新内容与上一次响应高度相似，只保留差异部分
        if (lastResponseContent && newContent.includes(lastResponseContent)) {
            return newContent.replace(lastResponseContent, '').trim();
        }

        // 句子级去重
        const sentences = newContent.split(/(?<=[.!?])\s+/);
        const seen = new Set();
        const uniqueSentences = [];

        for (const sentence of sentences) {
            const trimmed = sentence.trim();
            if (trimmed && !seen.has(trimmed)) {
                seen.add(trimmed);
                uniqueSentences.push(sentence);
            }
        }

        const result = uniqueSentences.join(' ');
        lastResponseContent = result; // 保存当前内容用于下次对比
        return result;
    }

    // 发送消息到后端
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const text = input.value.trim();

        // 验证发送条件
        if (isStreaming || !text || text === 'null') return;

        try {
            // 更新状态
            isStreaming = true;
            sendBtn.disabled = true;
            input.disabled = true;

            // 显示用户消息
            addUserMessage(text);
            input.value = '';
            input.style.height = 'auto';

            // 创建AI消息容器
            const aiMsgEl = createAiMessage();
            let fullContent = '';
            let chunkBuffer = '';

            // 发送请求到后端
            const response = await fetch('http://localhost:18080/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                    'Accept': 'text/event-stream'
                },
                body: text
            });

            if (!response.ok) {
                throw new Error(`请求失败: ${response.status} ${response.statusText}`);
            }

            if (!response.body) {
                throw new Error('后端不支持流式响应');
            }

            // 处理流式响应
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                // 解码并累积数据
                chunkBuffer += decoder.decode(value, { stream: true });

                // 处理数据块
                const cleaned = cleanChunk(chunkBuffer);
                if (cleaned) {
                    fullContent += cleaned + '\n';
                    chunkBuffer = '';

                    // 去重并更新UI
                    const uniqueContent = removeDuplicates(fullContent);
                    updateAiMessage(aiMsgEl, uniqueContent);
                }
            }

            // 处理剩余数据
            if (chunkBuffer) {
                fullContent += cleanChunk(chunkBuffer);
                const uniqueContent = removeDuplicates(fullContent);
                updateAiMessage(aiMsgEl, uniqueContent);
            }

        } catch (error) {
            console.error('错误详情:', error);
            const messages = document.getElementById('messages');
            const errEl = document.createElement('div');
            errEl.className = 'message ai-message';
            errEl.textContent = `出错了: ${error.message}`;
            messages.appendChild(errEl);
            scrollToBottom();
        } finally {
            // 恢复状态
            isStreaming = false;
            sendBtn.disabled = false;
            input.disabled = false;
            input.focus();
        }
    }

    // 绑定Enter键发送消息
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // 自动调整输入框高度
    document.getElementById('messageInput').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
</script>
</body>
</html>
