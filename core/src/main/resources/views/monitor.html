<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE ç›‘æ§ä¸­å¿ƒ</title>
    <script src="/views/js/tailwindcss.js" type="application/javascript"></script>
    <link href="/views/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#86909C',
                        added: '#00B42A',
                        removed: '#F53F3F',
                        traceIn: '#165DFF',
                        traceOut: '#722ED1',
                        traceException: '#F53F3F',
                        requestSync: '#14C9C9',
                        requestAsync: '#722ED1',
                        requestUnknown: '#86909C',
                        messageUser: '#00B42A',
                        messageTool: '#FF7D00',
                        messageAssistant: '#00B42A',
                        messageSystem: '#86909C'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .scrollbar-thin {
                scrollbar-width: thin;
            }

            .scrollbar-thin::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }

            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: #d1d5db;
                border-radius: 2px;
            }

            .card-hover {
                transition: all 0.2s ease;
            }

            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-gray-800 min-h-screen flex flex-col">
<!-- é¡¶éƒ¨å¯¼èˆª -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center mb-4 md:mb-0">
            <i class="fa fa-bolt text-primary text-2xl mr-3"></i>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">å®æ—¶ç›‘æ§</h1>
            <span id="connection-status" class="ml-4 px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-600">
                    <i class="fa fa-circle text-gray-400 animate-pulse"></i> æœªè¿æ¥
                </span>
        </div>
        <div class="flex items-center space-x-3">
            <!-- SSE åœ°å€é…ç½® -->
            <div class="relative">
                <input type="text" id="sse-url-input" placeholder="SSE åç«¯åœ°å€"
                       value="http://localhost:18080/monitor-sse" style="width: 260px;"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
            </div>
            <button id="connect-btn"
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center">
                <i class="fa fa-plug mr-2"></i> è¿æ¥ SSE
            </button>
            <button id="clear-btn"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors flex items-center">
                <i class="fa fa-trash mr-2"></i> æ¸…ç©ºæ—¥å¿—
            </button>
        </div>
    </div>
    <!-- æœç´¢æ  - ä»…å¢å¼ºå…¨å±€æœç´¢æ¡†ï¼Œç§»é™¤å³ä¾§æ–°å¢ç­›é€‰ -->
    <div class="container mx-auto px-4 pb-4">
        <div class="flex flex-col md:flex-row gap-3">
            <div class="relative flex-1">
                <!-- ä¼˜åŒ–æœç´¢æç¤ºï¼Œæ˜ç¡®åŒ…å« Message Type å’Œ Simple Name -->
                <input type="text" id="search-input"
                       placeholder="æœç´¢ conversationId/sceneId/description/text/MessageType/SimpleName..."
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                <i class="fa fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div class="flex gap-2 flex-wrap">
                <select id="filter-type"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary bg-white">
                    <option value="all">æ‰€æœ‰ç±»å‹</option>
                    <option value="traceMessage">è½¨è¿¹ä¿¡æ¯</option>
                    <option value="messageWrapper">æ¶ˆæ¯ä¿¡æ¯</option>
                </select>
                <select id="filter-changeType"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary bg-white">
                    <option value="all">æ‰€æœ‰å˜æ›´ç±»å‹</option>
                    <option value="ADDED">æ·»åŠ </option>
                    <option value="REMOVED">ç§»é™¤</option>
                </select>
            </div>
        </div>
    </div>
</header>

<!-- ä¸»è¦å†…å®¹ -->
<main class="flex-1 container mx-auto px-4 py-6">
    <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆä¿®å¤é‡‘åˆšåŒºå›¾æ ‡ä¸¢å¤±é—®é¢˜ï¼‰ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4 card-hover">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-500 text-sm font-medium">æ€»æ¶ˆæ¯æ•°</h3>
                <i class="fa fa-file-text-o text-primary text-xl"></i>
            </div>
            <p id="total-count" class="text-2xl font-bold mt-2">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 card-hover">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-500 text-sm font-medium">è½¨è¿¹ä¿¡æ¯æ•°</h3>
                <!-- æ›¿æ¢ä¸º FontAwesome 4.7 å…¼å®¹çš„è½¨è¿¹å›¾æ ‡ï¼Œé¿å…ä¸¢å¤± -->
                <i class="fa fa-location-arrow text-traceIn text-xl"></i>
            </div>
            <p id="trace-count" class="text-2xl font-bold mt-2">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 card-hover">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-500 text-sm font-medium">è®°å¿†ä¿¡æ¯æ•°</h3>
                <!-- æ›¿æ¢ä¸º FontAwesome 4.7 å…¼å®¹çš„æ¶ˆæ¯å›¾æ ‡ï¼Œé¿å…ä¸¢å¤± -->
                <i class="fa fa-commenting-o text-messageAssistant text-xl"></i>
            </div>
            <p id="message-count" class="text-2xl font-bold mt-2">0</p>
        </div>
    </div>

    <!-- æ—¥å¿—åˆ—è¡¨ -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="font-semibold text-lg">å®æ—¶æ—¥å¿—åˆ—è¡¨</h2>
            <div class="text-sm text-gray-500">
                <span id="log-count">0</span> æ¡è®°å½•
            </div>
        </div>
        <div id="logs-container" class="max-h-[70vh] overflow-y-auto scrollbar-thin">
            <div class="px-6 py-4 text-center text-gray-500 border-b border-gray-100">
                <i class="fa fa-info-circle mr-2"></i> ç­‰å¾… SSE è¿æ¥å¹¶æ¥æ”¶æ•°æ®...
            </div>
        </div>
    </div>
</main>

<!-- é¡µè„š -->
<footer class="bg-white border-t border-gray-200 py-4 mt-6">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
        <p>å®æ—¶ç›‘æ§ç³»ç»Ÿ Â© world.dahua.com</p>
    </div>
</footer>

<script>
    // å…¨å±€å˜é‡ - æ¢å¤åŸæœ‰å˜é‡ï¼Œç§»é™¤æ–°å¢ç­›é€‰å˜é‡
    let eventSource = null;
    let logs = [];
    let searchTerm = '';
    let filterType = 'all';
    let filterChangeType = 'all';
    let reconnectTimer = null; // é‡è¿å®šæ—¶å™¨
    const RECONNECT_DELAY = 3000; // é‡è¿å»¶è¿Ÿ 3 ç§’

    // DOM å…ƒç´  - æ¢å¤åŸæœ‰å…ƒç´ ï¼Œç§»é™¤æ–°å¢ç­›é€‰å…ƒç´ 
    const connectionStatus = document.getElementById('connection-status');
    const connectBtn = document.getElementById('connect-btn');
    const clearBtn = document.getElementById('clear-btn');
    const logsContainer = document.getElementById('logs-container');
    const searchInput = document.getElementById('search-input');
    const filterTypeSelect = document.getElementById('filter-type');
    const filterChangeTypeSelect = document.getElementById('filter-changeType');
    const totalCountEl = document.getElementById('total-count');
    const traceCountEl = document.getElementById('trace-count');
    const messageCountEl = document.getElementById('message-count');
    const logCountEl = document.getElementById('log-count');
    const sseUrlInput = document.getElementById('sse-url-input');

    // åˆå§‹åŒ– - æ¢å¤åŸæœ‰äº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', () => {
        connectBtn.addEventListener('click', toggleConnection);
        clearBtn.addEventListener('click', clearLogs);
        searchInput.addEventListener('input', handleSearch);
        filterTypeSelect.addEventListener('change', handleFilterChange);
        filterChangeTypeSelect.addEventListener('change', handleFilterChange);

        // ç›‘å¬åœ°å€è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        sseUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') toggleConnection();
        });
    });

    // æ ¸å¿ƒï¼šç¨³å®šçš„ SSE è¿æ¥é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
    function toggleConnection() {
        // æ¸…é™¤é‡è¿å®šæ—¶å™¨
        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }

        if (eventSource) {
            // ä¸»åŠ¨å…³é—­è¿æ¥
            eventSource.close();
            eventSource = null;
            updateConnectionStatus('disconnected');
            connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i> è¿æ¥ SSE';
            connectBtn.classList.remove('bg-danger');
            connectBtn.classList.add('bg-primary');
            return;
        }

        // è·å–å¹¶éªŒè¯åœ°å€
        const sseUrl = sseUrlInput.value.trim();
        if (!sseUrl) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ SSE åç«¯åœ°å€ï¼');
            return;
        }

        // éªŒè¯åœ°å€æ ¼å¼
        try {
            new URL(sseUrl); // ç®€å•éªŒè¯ URL æ ¼å¼
        } catch (err) {
            alert('SSE åœ°å€æ ¼å¼é”™è¯¯ï¼è¯·è¾“å…¥å¦‚ http://localhost:18080/monitor çš„åœ°å€');
            return;
        }

        // å¼€å§‹è¿æ¥
        updateConnectionStatus('connecting');
        connectBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> è¿æ¥ä¸­...';
        connectBtn.disabled = true;

        try {
            // åˆ›å»º SSE è¿æ¥ï¼ˆæ—  withCredentialsï¼Œé¿å… CORS é—®é¢˜ï¼‰
            eventSource = new EventSource(sseUrl, {
                withCredentials: false // æ˜¾å¼å…³é—­ï¼Œé¿å…éšå¼å¼€å¯
            });

            // è¿æ¥æˆåŠŸ
            eventSource.onopen = (e) => {
                console.log('âœ… SSE è¿æ¥æˆåŠŸ', e);
                updateConnectionStatus('connected');
                connectBtn.innerHTML = '<i class="fa fa-unplug mr-2"></i> æ–­å¼€è¿æ¥';
                connectBtn.classList.remove('bg-primary');
                connectBtn.classList.add('bg-danger');
                connectBtn.disabled = false;
            };

            // æ¥æ”¶æ¶ˆæ¯ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
            eventSource.onmessage = (e) => {
                console.log('ğŸ“¥ æ”¶åˆ° SSE æ¶ˆæ¯:', e.data);
                let data = null;

                // å…¼å®¹å„ç§æ•°æ®æ ¼å¼
                try {
                    // ç§»é™¤å¯èƒ½çš„å‰ç¼€/åç¼€
                    let cleanData = e.data.trim().replace(/^data:/, '').trim();
                    // å¤„ç†å¤šè¡Œ JSON
                    if (cleanData.includes('\n')) {
                        cleanData = cleanData.split('\n').filter(line => line.trim()).join('');
                    }
                    data = JSON.parse(cleanData);
                } catch (err) {
                    console.warn('âš ï¸ æ¶ˆæ¯è§£æå¤±è´¥ï¼Œè·³è¿‡:', err.message);
                    // è®°å½•åŸå§‹æ•°æ®åˆ°æ—¥å¿—ï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰
                    logs.unshift({
                        receiveTime: new Date().toLocaleString(),
                        changeEventType: 'ERROR',
                        traceMessage: {
                            conversationId: 'parse_error',
                            description: 'æ¶ˆæ¯è§£æå¤±è´¥',
                            simpleName: 'JSON Parse Error',
                            traceType: 'EXCEPTION',
                            requestType: 'UNKNOW',
                            time: Date.now()
                        }
                    });
                    updateStatistics();
                    renderLogs();
                    return;
                }

                if (data) {
                    processLogData(data);
                }
            };

            // é”™è¯¯å¤„ç†ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
            eventSource.onerror = (e) => {
                console.error('âŒ SSE é”™è¯¯:', e, 'çŠ¶æ€:', eventSource.readyState);

                // è¿æ¥å…³é—­æ—¶çš„å¤„ç†
                if (eventSource.readyState === EventSource.CLOSED) {
                    const errorMsg = `SSE è¿æ¥æ–­å¼€ï¼\nåœ°å€: ${sseUrl}\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨\n2. åç«¯è·¨åŸŸé…ç½®æ˜¯å¦å…è®¸å½“å‰æº\n3. åœ°å€æ˜¯å¦æ­£ç¡®`;
                    updateConnectionStatus('error');
                    // ä»…ä¸»åŠ¨è¿æ¥æ—¶å¼¹å‡ºæç¤ºï¼Œè‡ªåŠ¨é‡è¿æ—¶ä¸å¼¹
                    if (!reconnectTimer) {
                        alert(errorMsg);
                    }

                    // é‡ç½®è¿æ¥çŠ¶æ€
                    eventSource = null;
                    connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i> è¿æ¥ SSE';
                    connectBtn.classList.remove('bg-danger');
                    connectBtn.classList.add('bg-primary');
                    connectBtn.disabled = false;

                    // è‡ªåŠ¨é‡è¿ï¼ˆå¯é€‰ï¼Œæ³¨é‡Šæ‰åˆ™å…³é—­è‡ªåŠ¨é‡è¿ï¼‰
                    // reconnectTimer = setTimeout(() => {
                    //     console.log('ğŸ”„ å°è¯•è‡ªåŠ¨é‡è¿...');
                    //     toggleConnection();
                    // }, RECONNECT_DELAY);
                }
                // è¿æ¥ä¸­é”™è¯¯
                else if (eventSource.readyState === EventSource.CONNECTING) {
                    updateConnectionStatus('connecting');
                }
            };

        } catch (err) {
            console.error('âŒ åˆ›å»º SSE è¿æ¥å¤±è´¥:', err);
            alert(`è¿æ¥å¤±è´¥ï¼š${err.message}\nåœ°å€: ${sseUrl}`);
            updateConnectionStatus('error');
            connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i> è¿æ¥ SSE';
            connectBtn.classList.remove('bg-danger');
            connectBtn.classList.add('bg-primary');
            connectBtn.disabled = false;
            eventSource = null;
        }
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤ºï¼ˆä¿æŒä¸å˜ï¼‰
    function updateConnectionStatus(status) {
        const statusMap = {
            connecting: {
                html: '<i class="fa fa-circle text-warning animate-pulse"></i> æ­£åœ¨è¿æ¥',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-warning/10 text-warning'
            },
            connected: {
                html: '<i class="fa fa-circle text-success animate-pulse"></i> å·²è¿æ¥',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-success/10 text-success'
            },
            disconnected: {
                html: '<i class="fa fa-circle text-gray-400"></i> å·²æ–­å¼€',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-600'
            },
            error: {
                html: '<i class="fa fa-circle text-danger"></i> è¿æ¥é”™è¯¯',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-danger/10 text-danger'
            }
        };
        connectionStatus.innerHTML = statusMap[status].html;
        connectionStatus.className = statusMap[status].class;
    }

    // å¤„ç†æ—¥å¿—æ•°æ®ï¼ˆä¿æŒä¸å˜ï¼‰
    function processLogData(data) {
        if (data.connectionType) {
            return
        }
        data.receiveTime = new Date().toLocaleString();
        logs.unshift(data);
        updateStatistics();
        renderLogs();
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¿æŒä¸å˜ï¼‰
    function updateStatistics() {
        const total = logs.length;
        const traceCount = logs.filter(item => item.traceMessage).length;
        const messageCount = logs.filter(item => item.messageWrapper).length;

        totalCountEl.textContent = total;
        traceCountEl.textContent = traceCount;
        messageCountEl.textContent = messageCount;
    }

    // æœç´¢å’Œç­›é€‰é€»è¾‘ - æ ¸å¿ƒå¢å¼ºï¼šå…¨å±€æœç´¢åŒ…å« Message Type å’Œ Simple Name
    function handleSearch(e) {
        searchTerm = e.target.value.toLowerCase().trim();
        renderLogs();
    }

    function handleFilterChange() {
        filterType = filterTypeSelect.value;
        filterChangeType = filterChangeTypeSelect.value;
        renderLogs();
    }

    function filterLogs() {
        return logs.filter(log => {
            // 1. åŸºç¡€ç±»å‹ç­›é€‰ï¼ˆä¿æŒä¸å˜ï¼‰
            if (filterType !== 'all') {
                if (filterType === 'traceMessage' && !log.traceMessage) return false;
                if (filterType === 'messageWrapper' && !log.messageWrapper) return false;
            }

            // 2. å˜æ›´ç±»å‹ç­›é€‰ï¼ˆä¿æŒä¸å˜ï¼‰
            if (filterChangeType !== 'all' && log.changeEventType !== filterChangeType) return false;

            // 3. å…¨å±€æœç´¢ - å¢å¼ºï¼šåŒ…å« Message Type å’Œ Simple Name
            if (searchTerm) {
                const searchable = [
                    // åŸæœ‰æœç´¢é¡¹
                    log.traceMessage?.conversationId || '',
                    log.traceMessage?.sceneId || '',
                    log.traceMessage?.description || '',
                    log.messageWrapper?.conversationId || '',
                    log.messageWrapper?.sceneId || '',
                    log.messageWrapper?.text || '',
                    // æ–°å¢æœç´¢é¡¹ï¼ˆæ ¸å¿ƒï¼‰
                    log.traceMessage?.simpleName || '', // Simple Nameï¼ˆè½¨è¿¹ä¿¡æ¯ï¼‰
                    (log.messageWrapper?.messageType || '').toLowerCase() // Message Typeï¼ˆæ¶ˆæ¯ä¿¡æ¯ï¼Œå…¼å®¹å¤§å°å†™ï¼‰
                ].join(' ').toLowerCase();
                if (!searchable.includes(searchTerm)) return false;
            }

            return true;
        });
    }

    // æ¸²æŸ“æ—¥å¿—ï¼ˆä¿æŒä¸å˜ï¼‰
    function renderLogs() {
        const filteredLogs = filterLogs();
        logCountEl.textContent = filteredLogs.length;

        if (filteredLogs.length === 0) {
            logsContainer.innerHTML = `
                    <div class="px-6 py-4 text-center text-gray-500 border-b border-gray-100">
                        <i class="fa fa-search mr-2"></i> æœªæ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—è®°å½•
                    </div>
                `;
            return;
        }
        logsContainer.innerHTML = filteredLogs.map(log => createLogCard(log)).join('');
    }

    // åˆ›å»ºæ—¥å¿—å¡ç‰‡ï¼ˆä¿®å¤å›¾æ ‡ä¸¢å¤±ï¼Œä¼˜åŒ– ASSISTANT å’Œè½¨è¿¹å›¾æ ‡ï¼‰
    function createLogCard(log) {
        const isTrace = !!log.traceMessage;
        const changeTypeClass = log.changeEventType === 'ADDED' ? 'text-added' : 'text-removed';
        const changeTypeIcon = log.changeEventType === 'ADDED' ? 'fa-plus-circle' : 'fa-minus-circle';
        const time = log.traceMessage?.time || log.messageWrapper?.time || log.receiveTime;
        const formattedTime = typeof time === 'number' ? new Date(time).toLocaleString() : time;

        // é€šç”¨ä¹±ç è§£ç 
        const decodeText = (str) => {
            if (!str) return 'æ— ';
            try {
                str = str.replace(/\\u([0-9a-fA-F]{4})/g, (_, p1) => String.fromCharCode(parseInt(p1, 16)));
                return decodeURIComponent(escape(str));
            } catch (e) {
                return str;
            }
        };

        // è½¨è¿¹ä¿¡æ¯å¡ç‰‡ - ä¼˜åŒ–è½¨è¿¹å›¾æ ‡ï¼ˆä½¿ç”¨ FontAwesome 4.7 å…¼å®¹å›¾æ ‡ï¼‰
        if (isTrace) {
            const trace = log.traceMessage;
            const traceTypeClass = {
                'IN': 'text-traceIn',
                'OUT': 'text-traceOut',
                'EXCEPTION': 'text-traceException'
            }[trace.traceType] || 'text-info';
            // ä¼˜åŒ–è½¨è¿¹ç±»å‹å›¾æ ‡ï¼ˆæ›¿æ¢ä¸º 4.7 å…¼å®¹ç‰ˆæœ¬ï¼‰
            const traceTypeIcon = {
                'IN': 'fa-long-arrow-right',
                'OUT': 'fa-long-arrow-left',
                'EXCEPTION': 'fa-exclamation-triangle'
            }[trace.traceType] || 'fa-question';
            const requestTypeClass = {
                'SYNC': 'text-requestSync',
                'ASYNC': 'text-requestAsync',
                'UNKNOW': 'text-requestUnknown'
            }[trace.requestType] || 'text-info';
            const description = decodeText(trace.description);
            // è½¨è¿¹æ ‡é¢˜ï¼šè½¨è¿¹-xxxï¼ˆSimple Nameï¼Œæ— åˆ™æ˜¾ç¤º"æœªçŸ¥"ï¼‰
            const traceTitle = `è½¨è¿¹-${trace.simpleName || 'æœªçŸ¥'}`;

            return `
                    <div class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <div class="px-6 py-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center">
                                    <!-- æ›¿æ¢ä¸º FontAwesome 4.7 å…¼å®¹çš„è½¨è¿¹ä¸»å›¾æ ‡ï¼Œé¿å…ä¸¢å¤± -->
                                    <span class="bg-blue-50 p-2 rounded-full mr-3"><i class="fa fa-map-signs text-traceIn"></i></span>
                                    <div>
                                        <h3 class="font-medium text-gray-800">${traceTitle}</h3>
                                    </div>
                                </div>
                                <span class="${changeTypeClass} text-xs flex items-center">
                                    <i class="fa ${changeTypeIcon} mr-1"></i> ${log.changeEventType}
                                </span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 text-sm">
                                <div><span class="text-gray-500">Conversation ID:</span> <span class="font-medium ml-1">${trace.conversationId || 'æ— '}</span></div>
                                <div><span class="text-gray-500">Simple Name:</span> <span class="font-medium ml-1">${trace.simpleName || 'æ— '}</span></div>
                                <div><span class="text-gray-500">æè¿°:</span> <span class="font-medium ml-1">${description}</span></div>
                                <div class="flex items-center"><span class="text-gray-500">Trace Type:</span> 
                                    <span class="${traceTypeClass} font-medium ml-1 flex items-center">
                                        <i class="fa ${traceTypeIcon} mr-1"></i> ${trace.traceType || 'æœªçŸ¥'}
                                    </span>
                                </div>
                                <div class="flex items-center"><span class="text-gray-500">Request Type:</span> 
                                    <span class="${requestTypeClass} font-medium ml-1">${trace.requestType || 'UNKNOW'}</span>
                                </div>
                                <div><span class="text-gray-500">æ—¶é—´:</span> <span class="font-medium ml-1">${formattedTime}</span></div>
                            </div>
                        </div>
                    </div>
                `;
        }
        // æ¶ˆæ¯ä¿¡æ¯å¡ç‰‡ - ä¼˜åŒ– ASSISTANT å›¾æ ‡ï¼ˆä½¿ç”¨ FontAwesome 4.7 å…¼å®¹å›¾æ ‡ï¼‰
        else {
            const message = log.messageWrapper;
            // ä¿®å¤æ¶ˆæ¯ç±»å‹æ ·å¼ç±»ï¼ˆå…¼å®¹å¤§å°å†™ï¼‰
            const messageTypeNormalized = (message.messageType || '').toUpperCase();
            const messageTypeClass = {
                'USER': 'text-messageUser',
                'TOOL': 'text-messageTool',
                'ASSISTANT': 'text-messageAssistant',
                'SYSTEM': 'text-messageSystem'
            }[messageTypeNormalized] || 'text-info';
            // ä¼˜åŒ– ASSISTANT å›¾æ ‡ï¼ˆæ›¿æ¢ä¸º FontAwesome 4.7 å…¼å®¹çš„æ›´ç¾è§‚å›¾æ ‡ï¼‰
            const messageTypeIcon = {
                'USER': 'fa-user',                // ç”¨æˆ· - å®å¿ƒå›¾æ ‡
                'TOOL': 'fa-wrench',              // å·¥å…· - ä¿æŒä¸å˜
                'ASSISTANT': 'fa-headphones',          // åŠ©æ‰‹ - æ›¿æ¢ä¸ºæœºå™¨äººå›¾æ ‡ï¼ˆ4.7 å…¼å®¹ï¼‰
                'SYSTEM': 'fa-cog'                // ç³»ç»Ÿ - ä¿æŒä¸å˜
            }[messageTypeNormalized] || 'fa-comment';
            const text = decodeText(message.text).replace(/\\n/g, '<br>').replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
            // æ¶ˆæ¯æ ‡é¢˜ï¼šæ¶ˆæ¯-xxxï¼ˆæ¶ˆæ¯ç±»å‹ï¼Œæ— åˆ™æ˜¾ç¤º"æœªçŸ¥"ï¼‰
            const messageTitle = `è®°å¿†-${message.messageType || 'æœªçŸ¥'}`;

            return `
                    <div class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <div class="px-6 py-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center">
                                    <!-- æ¶ˆæ¯å¡ç‰‡ä¸»å›¾æ ‡ä½¿ç”¨ 4.7 å…¼å®¹ç‰ˆæœ¬ -->
                                    <span class="bg-green-50 p-2 rounded-full mr-3"><i class="fa ${messageTypeIcon} ${messageTypeClass}"></i></span>
                                    <div>
                                        <h3 class="font-medium text-gray-800">${messageTitle}</h3>
                                    </div>
                                </div>
                                <span class="${changeTypeClass} text-xs flex items-center">
                                    <i class="fa ${changeTypeIcon} mr-1"></i> ${log.changeEventType}
                                </span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 text-sm">
                                <div><span class="text-gray-500">Conversation ID:</span> <span class="font-medium ml-1">${message.conversationId || 'æ— '}</span></div>
                                <div class="flex items-center"><span class="text-gray-500">Message Type:</span> 
                                    <span class="${messageTypeClass} font-medium ml-1 flex items-center">
                                        <i class="fa ${messageTypeIcon} mr-1"></i> ${message.messageType || 'æœªçŸ¥'}
                                    </span>
                                </div>
                                <div><span class="text-gray-500">Scene ID:</span> <span class="font-medium ml-1 text-xs break-all">${message.sceneId || 'æ— '}</span></div>
                                <div><span class="text-gray-500">æ—¶é—´æˆ³:</span> <span class="font-medium ml-1">${formattedTime}</span></div>
                            </div>
                            <div class="mt-4 text-sm">
                                <span class="text-gray-500 block mb-2">æ¶ˆæ¯å†…å®¹:</span>
                                <div class="bg-gray-50 p-3 rounded-md border border-gray-200 whitespace-pre-line">${text}</div>
                            </div>
                        </div>
                    </div>
                `;
        }
    }

    // æ¸…ç©ºæ—¥å¿—ï¼ˆä¿æŒä¸å˜ï¼‰
    function clearLogs() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—è®°å½•å—ï¼Ÿ')) {
            logs = [];
            updateStatistics();
            renderLogs();
        }
    }

    // é¡µé¢å…³é—­æ—¶æ¸…ç†è¿æ¥ï¼ˆä¿æŒä¸å˜ï¼‰
    window.addEventListener('beforeunload', () => {
        if (eventSource) eventSource.close();
        if (reconnectTimer) clearTimeout(reconnectTimer);
    });
</script>
</body>
</html>
