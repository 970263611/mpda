<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 原有头部代码完全不变 -->
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>监控中心</title>
    <script src="/views/js/tailwindcss.js" type="application/javascript"></script>
    <link href="/views/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#86909C',
                        added: '#00B42A',
                        removed: '#F53F3F',
                        traceIn: '#165DFF',
                        traceOut: '#722ED1',
                        traceException: '#F53F3F',
                        requestSync: '#14C9C9',
                        requestAsync: '#722ED1',
                        requestUnknown: '#86909C',
                        messageUser: '#00B42A',
                        messageTool: '#FF7D00',
                        messageAssistant: '#00B42A',
                        messageSystem: '#86909C',
                        memory: '#9333EA' // 记忆管理模块颜色
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        /* 原有样式完全不变 */
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .scrollbar-thin {
                scrollbar-width: thin;
            }

            .scrollbar-thin::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }

            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: #d1d5db;
                border-radius: 2px;
            }

            .card-hover {
                transition: all 0.2s ease;
            }

            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            }

            /* 多选下拉框样式 */
            .multi-select {
                position: relative;
            }

            .multi-select-selected {
                cursor: pointer;
                user-select: none;
            }

            .multi-select-options {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                z-index: 100;
                max-height: 200px;
                overflow-y: auto;
                margin-top: 0.25rem;
                width: 110%;
            }

            .multi-select-options.show {
                display: block;
            }

            .multi-select-option {
                padding: 0.5rem 0.75rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .multi-select-option:hover {
                background-color: #f3f4f6;
            }

            .multi-select-option input[type="checkbox"] {
                margin-right: 0.5rem;
            }

            /* JSON美化样式 */
            .json-beautify {
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                word-break: break-all;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-gray-800 min-h-screen flex flex-col">
<!-- 原有HTML结构完全不变 -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center mb-4 md:mb-0">
            <i class="fa fa-bolt text-primary text-2xl mr-3"></i>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">实时监控</h1>
            <span class="ml-4 px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-600" id="connection-status">
                    <i class="fa fa-circle text-gray-400 animate-pulse"></i> 未连接
                </span>
        </div>
        <div class="flex items-center space-x-3">
            <!-- SSE 地址配置 -->
            <div class="relative">
                <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"
                       id="sse-url-input" placeholder="SSE 后端地址"
                       style="min-width: 260px; max-width: 590px;" type="text">
            </div>
            <!-- 时间范围选择 -->
            <div class="flex items-center space-x-2">
                <input type="datetime-local" id="start-time"
                       class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
                <span class="text-gray-500">至</span>
                <input type="datetime-local" id="end-time"
                       class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
            </div>
            <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center"
                    id="connect-btn">
                <i class="fa fa-plug mr-2"></i> 连接 SSE
            </button>
            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors flex items-center"
                    id="clear-btn">
                <i class="fa fa-trash mr-2"></i> 清空日志
            </button>
        </div>
    </div>
    <!-- 搜索栏 -->
    <div class="container mx-auto px-4 pb-4">
        <div class="flex flex-col md:flex-row gap-3">
            <div class="relative flex-1">
                <input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                       id="search-input"
                       placeholder="搜索 Conversation ID/Scene ID/场景描述/节点名称/消息类型/消息内容"
                       type="text">
                <i class="fa fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div class="flex gap-2 flex-wrap">
                <!-- 类型筛选 - 改为多选 -->
                <div class="multi-select" id="filter-type-multi">
                    <div class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary bg-white multi-select-selected">
                        <div class="flex justify-between items-center">
                            <span id="filter-type-text">所有类型</span>
                            <i class="fa fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>
                    <div class="multi-select-options">
                        <div class="multi-select-option">
                            <input type="checkbox" id="type-all" value="all">
                            <label for="type-all">所有类型</label>
                        </div>
                        <div class="multi-select-option">
                            <input type="checkbox" id="type-trace" value="traceMessage">
                            <label for="type-trace">轨迹信息</label>
                        </div>
                        <div class="multi-select-option">
                            <input type="checkbox" id="type-message" value="messageWrapper">
                            <label for="type-message">消息信息</label>
                        </div>
                        <div class="multi-select-option">
                            <input type="checkbox" id="type-memory" value="memoryWrapper">
                            <label for="type-memory">记忆管理</label>
                        </div>
                    </div>
                </div>

                <select class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary bg-white"
                        id="filter-changeType">
                    <option value="all">所有变更类型</option>
                    <option value="ADDED">添加</option>
                    <option value="REMOVED">移除</option>
                </select>
            </div>
        </div>
    </div>
</header>

<!-- 主要内容 -->
<main class="flex-1 container mx-auto px-4 py-6">
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4 card-hover">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-500 text-sm font-medium">总消息数</h3>
                <i class="fa fa-file-text-o text-primary text-xl"></i>
            </div>
            <p class="text-2xl font-bold mt-2" id="total-count">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 card-hover">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-500 text-sm font-medium">轨迹信息数</h3>
                <i class="fa fa-location-arrow text-traceIn text-xl"></i>
            </div>
            <p class="text-2xl font-bold mt-2" id="trace-count">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 card-hover">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-500 text-sm font-medium">消息信息数</h3>
                <i class="fa fa-commenting-o text-messageAssistant text-xl"></i>
            </div>
            <p class="text-2xl font-bold mt-2" id="message-count">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 card-hover">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-500 text-sm font-medium">记忆管理数</h3>
                <i class="fa fa-database text-memory text-xl"></i>
            </div>
            <p class="text-2xl font-bold mt-2" id="memory-count">0</p>
        </div>
    </div>

    <!-- 日志列表 -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="font-semibold text-lg">实时日志列表</h2>
            <div class="text-sm text-gray-500">
                <span id="log-count">0</span> 条记录
            </div>
        </div>
        <div class="max-h-[70vh] overflow-y-auto scrollbar-thin" id="logs-container">
            <div class="px-6 py-4 text-center text-gray-500 border-b border-gray-100">
                <i class="fa fa-info-circle mr-2"></i> 等待 SSE 连接并接收数据...
            </div>
        </div>
    </div>
</main>

<!-- 页脚 -->
<footer class="bg-white border-t border-gray-200 py-4 mt-6">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
        <p>实时监控系统 © world.dahua.com</p>
    </div>
</footer>

<script>
    // 全局变量
    let eventSource = null;
    let logs = [];
    let searchTerm = '';
    let filterTypes = ['all']; // 改为数组，支持多选
    let filterChangeType = 'all';

    // DOM 元素
    const connectionStatus = document.getElementById('connection-status');
    const connectBtn = document.getElementById('connect-btn');
    const clearBtn = document.getElementById('clear-btn');
    const logsContainer = document.getElementById('logs-container');
    const searchInput = document.getElementById('search-input');
    const filterTypeMulti = document.getElementById('filter-type-multi');
    const filterTypeText = document.getElementById('filter-type-text');
    const filterChangeTypeSelect = document.getElementById('filter-changeType');
    const totalCountEl = document.getElementById('total-count');
    const traceCountEl = document.getElementById('trace-count');
    const messageCountEl = document.getElementById('message-count');
    const memoryCountEl = document.getElementById('memory-count');
    const logCountEl = document.getElementById('log-count');
    const sseUrlInput = document.getElementById('sse-url-input');
    const startTimeInput = document.getElementById('start-time');
    const endTimeInput = document.getElementById('end-time');

    const fullUrl = `${window.location.protocol}//${window.location.host}`
    sseUrlInput.value = fullUrl + "/monitor-sse"

    // 通用JSON美化函数
    function beautifyJson(content) {
        if (!content) return '无内容';

        // 处理已经是对象的情况
        let contentStr = typeof content === 'string' ? content : JSON.stringify(content);

        // 解码Unicode和URL编码
        try {
            contentStr = contentStr.replace(/\\u([0-9a-fA-F]{4})/g, (_, p1) =>
                String.fromCharCode(parseInt(p1, 16)));
            contentStr = decodeURIComponent(escape(contentStr));
        } catch (e) {
            // 解码失败则使用原始字符串
        }

        // 尝试解析并美化JSON
        try {
            const jsonObj = JSON.parse(contentStr);
            // 修改美化逻辑，减少缩进
            let beautified = JSON.stringify(jsonObj, null, 0); // 0表示不缩进
            beautified = beautified.replace(/^\s+/, ''); // 移除开头空格
            return beautified
                .replace(/\n/g, '<br>')
                .replace(/  /g, '&nbsp;&nbsp;'); // 只保留必要的空格替换
        } catch (e) {
            // 非JSON格式则处理换行和制表符后返回
            return contentStr
                .replace(/^\s+/, '') // 移除开头的所有空白字符
                .replace(/\n/g, '<br>')
                .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        connectBtn.addEventListener('click', toggleConnection);
        clearBtn.addEventListener('click', clearLogs);
        searchInput.addEventListener('input', handleSearch);
        filterChangeTypeSelect.addEventListener('change', handleFilterChange);

        // 监听地址输入框输入事件，动态调整宽度
        sseUrlInput.addEventListener('input', adjustInputWidth);
        // 初始化输入框宽度
        adjustInputWidth();

        // 监听地址输入框回车事件
        sseUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') toggleConnection();
        });

        // 初始化多选下拉框
        initMultiSelect();

        // 为记忆块折叠按钮添加事件委托
        logsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('memory-toggle-btn') || e.target.parentElement.classList.contains('memory-toggle-btn')) {
                const btn = e.target.classList.contains('memory-toggle-btn') ? e.target : e.target.parentElement;
                const memoryId = btn.getAttribute('data-memory-id');
                const content = document.getElementById(`memory-content-${memoryId}`);

                // 切换内容显示状态
                content.classList.toggle('hidden');

                // 切换图标
                const icon = btn.querySelector('i');
                if (content.classList.contains('hidden')) {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                } else {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            }
        });

        // ========== 新增：监听时间选择器变化，自动拼接参数到输入框 ==========
        startTimeInput.addEventListener('change', updateSseUrlWithTimeParams);
        endTimeInput.addEventListener('change', updateSseUrlWithTimeParams);
    });

    // ========== 新增：更新SSE地址输入框，拼接时间参数 ==========
    function updateSseUrlWithTimeParams() {
        // 获取原始地址（移除已有的begin/end参数）
        let baseUrl = sseUrlInput.value.trim();
        if (baseUrl) {
            // 移除已有的begin和end参数
            const urlObj = new URL(baseUrl, window.location.origin);
            urlObj.searchParams.delete('begin');
            urlObj.searchParams.delete('end');
            baseUrl = urlObj.href.split('?')[0];
        } else {
            baseUrl = '';
        }

        // 构建新参数
        const params = new URLSearchParams();
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;

        if (startTime) {
            params.append('begin', new Date(startTime).getTime().toString());
        }
        if (endTime) {
            params.append('end', new Date(endTime).getTime().toString());
        }

        // 拼接参数到地址
        const queryString = params.toString();
        let newUrl = baseUrl;
        if (queryString) {
            newUrl += (newUrl.includes('?') ? '&' : '?') + queryString;
        }

        // 更新输入框值并调整宽度
        sseUrlInput.value = newUrl;
        adjustInputWidth();
    }

    // 调整输入框宽度以适应内容
    function adjustInputWidth() {
        // 创建临时元素计算文本宽度
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.whiteSpace = 'nowrap';
        tempSpan.style.fontSize = window.getComputedStyle(sseUrlInput).fontSize;
        tempSpan.style.fontFamily = window.getComputedStyle(sseUrlInput).fontFamily;
        tempSpan.textContent = sseUrlInput.value || sseUrlInput.placeholder;
        document.body.appendChild(tempSpan);

        // 设置最小宽度为260px，最大宽度为800px，避免过宽
        const width = Math.max(260, Math.min(800, tempSpan.offsetWidth + 40)); // 加40px作为内边距和光标空间
        sseUrlInput.style.width = `${width}px`;

        document.body.removeChild(tempSpan);
    }

    // 初始化多选下拉框
    function initMultiSelect() {
        const selectedDiv = filterTypeMulti.querySelector('.multi-select-selected');
        const optionsDiv = filterTypeMulti.querySelector('.multi-select-options');
        const checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');

        // 切换下拉框显示/隐藏
        selectedDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            optionsDiv.classList.toggle('show');
        });

        // 点击其他地方关闭下拉框
        document.addEventListener('click', () => {
            optionsDiv.classList.remove('show');
        });

        // 处理选项点击
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleTypeCheckboxChange);
        });

        // 初始选中"所有类型"
        document.getElementById('type-all').checked = true;
        updateTypeSelection();
    }

    // 处理类型复选框变化
    function handleTypeCheckboxChange(e) {
        const checkboxes = filterTypeMulti.querySelectorAll('input[type="checkbox"]');
        const allCheckbox = document.getElementById('type-all');
        const clickedValue = e.target.value;

        if (clickedValue === 'all') {
            // 如果点击"所有类型"，则选中所有选项
            checkboxes.forEach(cb => cb.checked = true);
        } else {
            // 如果取消选中某个类型，同时取消选中"所有类型"
            if (!e.target.checked) {
                allCheckbox.checked = false;
            }

            // 检查是否所有类型都被选中，如果是则自动选中"所有类型"
            const allChecked = Array.from(checkboxes).every(cb => cb.value === 'all' || cb.checked);
            allCheckbox.checked = allChecked;
        }

        updateTypeSelection();
        handleFilterChange();
    }

    // 更新类型选择状态
    function updateTypeSelection() {
        const checkboxes = filterTypeMulti.querySelectorAll('input[type="checkbox"]');
        const selectedValues = Array.from(checkboxes)
            .filter(cb => cb.checked && cb.value !== 'all')
            .map(cb => cb.value);

        // 更新全局变量
        filterTypes = selectedValues.length === 0 ? ['all'] : selectedValues;

        // 更新显示文本
        if (filterTypes.includes('all') || selectedValues.length === 0) {
            filterTypeText.textContent = '所有类型';
        } else {
            filterTypeText.textContent = '已选择类型';
        }
    }

    // SSE 连接逻辑
    function toggleConnection() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            updateConnectionStatus('disconnected');
            connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i> 连接 SSE';
            connectBtn.classList.remove('bg-danger');
            connectBtn.classList.add('bg-primary');
            return;
        }

        let sseUrl = sseUrlInput.value.trim();
        if (!sseUrl) {
            alert('请输入有效的 SSE 后端地址！');
            return;
        }

        // 处理时间参数（这里保留原有逻辑，确保手动修改地址后也能正确处理）
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const params = new URLSearchParams();

        if (startTime) {
            params.append('begin', new Date(startTime).getTime().toString());
        }
        if (endTime) {
            params.append('end', new Date(endTime).getTime().toString());
        }

        // 拼接URL参数（如果输入框中已有参数，这里会覆盖，保证最终参数和时间选择器一致）
        const urlObj = new URL(sseUrl, window.location.origin);
        if (startTime) urlObj.searchParams.set('begin', new Date(startTime).getTime().toString());
        if (endTime) urlObj.searchParams.set('end', new Date(endTime).getTime().toString());
        sseUrl = urlObj.href;

        try {
            new URL(sseUrl);
        } catch (err) {
            alert('SSE 地址格式错误！请输入如 http://localhost:18080/monitor 的地址');
            return;
        }

        updateConnectionStatus('connecting');
        connectBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 连接中...';
        connectBtn.disabled = true;

        try {
            eventSource = new EventSource(sseUrl, {
                withCredentials: false
            });

            eventSource.onopen = (e) => {
                console.log('✅ SSE 连接成功', e);
                updateConnectionStatus('connected');
                connectBtn.innerHTML = '<i class="fa fa-unplug mr-2"></i> 断开连接';
                connectBtn.classList.remove('bg-primary');
                connectBtn.classList.add('bg-danger');
                connectBtn.disabled = false;
            };

            eventSource.onmessage = (e) => {
                let data = null;

                try {
                    let cleanData = e.data.trim().replace(/^data:/, '').trim();
                    if (cleanData.includes('\n')) {
                        cleanData = cleanData.split('\n').filter(line => line.trim()).join('');
                    }
                    data = JSON.parse(cleanData);
                } catch (err) {
                    console.warn('⚠️ 消息解析失败，跳过:', err.message);
                    logs.unshift({
                        receiveTime: new Date().toLocaleString(),
                        eventType: 'ERROR',
                        traceMessage: {
                            conversationId: 'parse_error',
                            description: '消息解析失败',
                            simpleName: 'JSON Parse Error',
                            traceType: 'EXCEPTION',
                            requestType: 'UNKNOW',
                            time: Date.now()
                        }
                    });
                    updateStatistics();
                    renderLogs();
                    return;
                }

                if (data) {
                    processLogData(data);
                }
            };

            eventSource.onerror = (e) => {
                console.error('❌ SSE 错误:', e, '状态:', eventSource.readyState);
                if (eventSource.readyState === EventSource.CLOSED) {
                    updateConnectionStatus('error');
                } else if (eventSource.readyState === EventSource.CONNECTING) {
                    updateConnectionStatus('connecting');
                }
                eventSource.close();
                connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i> 连接 SSE';
                connectBtn.classList.remove('bg-danger');
                connectBtn.classList.add('bg-primary');
                connectBtn.disabled = false;
                updateConnectionStatus('disconnected');
            };
        } catch (err) {
            console.error('❌ 创建 SSE 连接失败:', err);
            alert(`连接失败：${err.message}\n地址: ${sseUrl}`);
            updateConnectionStatus('error');
            connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i> 连接 SSE';
            connectBtn.classList.remove('bg-danger');
            connectBtn.classList.add('bg-primary');
            connectBtn.disabled = false;
            eventSource = null;
        }
    }

    // 更新连接状态显示
    function updateConnectionStatus(status) {
        const statusMap = {
            connecting: {
                html: '<i class="fa fa-circle text-warning animate-pulse"></i> 正在连接',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-warning/10 text-warning'
            },
            connected: {
                html: '<i class="fa fa-circle text-success animate-pulse"></i> 已连接',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-success/10 text-success'
            },
            disconnected: {
                html: '<i class="fa fa-circle text-gray-400"></i> 已断开',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-600'
            },
            error: {
                html: '<i class="fa fa-circle text-danger"></i> 连接错误',
                class: 'ml-4 px-2 py-1 rounded-full text-xs bg-danger/10 text-danger'
            }
        };
        connectionStatus.innerHTML = statusMap[status].html;
        connectionStatus.className = statusMap[status].class;
    }

    // 处理日志数据 - 确保所有日志都有统一的变更类型字段
    function processLogData(data) {
        if (data.connectionType) {
            return
        }

        // 确保日志有时间戳 - 优先使用日志自带的时间，否则使用当前时间
        if (data.traceMessage?.time) {
            data.timestamp = new Date(data.traceMessage.time).getTime();
        } else if (data.messageWrapper?.time) {
            data.timestamp = new Date(data.messageWrapper.time).getTime();
        } else if (data.memoryWrapper?.time) {
            data.timestamp = new Date(data.memoryWrapper.time).getTime();
        } else {
            data.timestamp = Date.now(); // 使用当前时间作为默认值
        }

        data.receiveTime = new Date().toLocaleString();
        logs.unshift(data);
        updateStatistics();
        renderLogs();
    }

    // 清空日志
    function clearLogs() {
        logs = [];
        updateStatistics();
        renderLogs();
    }

    // 更新统计信息
    function updateStatistics() {
        const total = logs.length;
        const traceCount = logs.filter(item => item.traceMessage).length;
        const messageCount = logs.filter(item => item.messageWrapper).length;
        const memoryCount = logs.filter(item => item.memoryWrapper).length;

        totalCountEl.textContent = total;
        traceCountEl.textContent = traceCount;
        messageCountEl.textContent = messageCount;
        memoryCountEl.textContent = memoryCount;
        logCountEl.textContent = filterLogs().length;
    }

    // 搜索和筛选逻辑
    function handleSearch(e) {
        searchTerm = e.target.value.toLowerCase().trim();
        renderLogs();
    }

    function handleFilterChange() {
        filterChangeType = filterChangeTypeSelect.value;
        renderLogs();
    }

    function filterLogs() {
        return logs.filter(log => {
            // 类型筛选 - 改为支持多选
            if (filterTypes.length > 0 && !filterTypes.includes('all')) {
                let matchesType = false;
                if (filterTypes.includes('traceMessage') && log.traceMessage) matchesType = true;
                if (filterTypes.includes('messageWrapper') && log.messageWrapper) matchesType = true;
                if (filterTypes.includes('memoryWrapper') && log.memoryWrapper) matchesType = true;
                if (!matchesType) return false;
            }

            // 变更类型筛选 - 检查eventType
            if (filterChangeType !== 'all') {
                const logChangeType = log.eventType;
                if (logChangeType !== filterChangeType) return false;
            }

            // 全局搜索
            if (searchTerm) {
                const searchable = [
                    log.traceMessage?.conversationId || '',
                    log.traceMessage?.sceneId || '',
                    log.traceMessage?.description || '',
                    log.messageWrapper?.conversationId || '',
                    log.messageWrapper?.sceneId || '',
                    log.messageWrapper?.text || '',
                    log.memoryWrapper?.conversationId || '',
                    log.memoryWrapper?.sceneId || '',
                    log.memoryWrapper?.messages.map(m => m.text).join(' ') || '',
                    log.traceMessage?.simpleName || '',
                    (log.messageWrapper?.messageType || '').toLowerCase(),
                    // 添加变更类型到搜索范围
                    (log.eventType || '').toLowerCase()
                ].join(' ').toLowerCase();
                if (!searchable.includes(searchTerm)) return false;
            }

            return true;
        });
    }

    // 渲染日志
    function renderLogs() {
        const filteredLogs = filterLogs();

        // 按时间戳排序 - 最新的日志排在前面
        filteredLogs.sort((a, b) => b.timestamp - a.timestamp);

        logCountEl.textContent = filteredLogs.length;

        if (filteredLogs.length === 0) {
            logsContainer.innerHTML = `
                    <div class="px-6 py-4 text-center text-gray-500 border-b border-gray-100">
                        <i class="fa fa-search mr-2"></i> 未找到匹配的日志记录
                    </div>
                `;
            return;
        }
        logsContainer.innerHTML = filteredLogs.map(log => createLogCard(log)).join('');
    }

    // 创建日志卡片
    function createLogCard(log) {
        const logChangeType = log.eventType;
        const changeTypeClass = logChangeType === 'ADDED' ? 'text-added' : 'text-removed';
        const changeTypeIcon = logChangeType === 'ADDED' ? 'fa-plus-circle' : 'fa-minus-circle';

        // 记忆管理卡片 - 增加了折叠功能
        if (log.memoryWrapper) {
            const memory = log.memoryWrapper;
            const formattedTime = typeof memory.time === 'number'
                ? new Date(memory.time).toLocaleString()
                : memory.time || new Date().toLocaleString();

            // 生成唯一ID用于折叠控制
            const memoryId = `memory-${Date.now()}-${Math.floor(Math.random() * 1000)}`;

            // 构建消息列表HTML
            const messagesHtml = memory.messages.map((msg, index) => {
                const msgText = msg.messageType === 'TOOL' ? msg.responses :
                    msg.messageType === 'ASSISTANT' ? (msg.text || msg.toolCalls) :
                        msg.text;
                const decodedText = beautifyJson(msgText);
                const msgTime = msg.time ? new Date(msg.time).toLocaleString() : '无时间';

                return `
                    <div class="mb-4 pb-4 border-b border-gray-100 last:border-0 last:mb-0 last:pb-0">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium ${
                    msg.messageType === 'USER' ? 'text-messageUser' :
                        msg.messageType === 'ASSISTANT' ? 'text-messageAssistant' :
                            msg.messageType === 'TOOL' ? 'text-messageTool' :
                                'text-messageSystem'
                }">
                                ${msg.messageType || '未知消息类型'}
                            </span>
                            <span class="text-xs text-gray-500">${msgTime}</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-md border border-gray-200 text-sm json-beautify">
                            ${decodedText}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <div class="px-6 py-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <span class="bg-purple-50 p-2 rounded-full mr-3"><i class="fa fa-save text-memory"></i></span>
                                <div>
                                    <h3 class="font-medium text-gray-800">记忆管理</h3>
                                </div>
                            </div>
                            <span class="${changeTypeClass} text-xs flex items-center">
                                <i class="fa ${changeTypeIcon} mr-1"></i> ${logChangeType}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 text-sm">
                            <div><span class="text-gray-500">Conversation ID:</span> <span class="font-medium ml-1">${memory.conversationId || '无'}</span></div>
                            <div><span class="text-gray-500">Scene ID:</span> <span class="font-medium ml-1 text-xs break-all">${memory.sceneId || '无'}</span></div>
                            <div><span class="text-gray-500">消息数量:</span> <span class="font-medium ml-1">${memory.messages?.length || 0}</span></div>
                            <div><span class="text-gray-500">时间戳:</span> <span class="font-medium ml-1">${formattedTime}</span></div>
                        </div>
                        <div class="mt-4 text-sm">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-500">消息列表:</span>
                                <button class="memory-toggle-btn text-xs text-primary flex items-center" data-memory-id="${memoryId}">
                                    <i class="fa fa-chevron-down mr-1"></i> 点击展开/折叠
                                </button>
                            </div>
                            <div id="memory-content-${memoryId}" class="hidden">
                                ${messagesHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 轨迹信息卡片
        if (log.traceMessage) {
            const trace = log.traceMessage;
            const traceTypeClass = trace.traceType === 'IN' ? 'text-traceIn' :
                trace.traceType === 'OUT' ? 'text-traceOut' : 'text-traceException';
            const traceIcon = trace.traceType === 'IN' ? 'fa-sign-in' :
                trace.traceType === 'OUT' ? 'fa-sign-out' : 'fa-exclamation-triangle';
            const requestTypeClass = trace.requestType === 'SYNC' ? 'text-requestSync' :
                trace.requestType === 'ASYNC' ? 'text-requestAsync' : 'text-requestUnknown';
            const formattedTime = typeof trace.time === 'number'
                ? new Date(trace.time).toLocaleString()
                : trace.time || new Date().toLocaleString();

            // 美化轨迹信息中的描述和其他JSON内容
            const beautifiedDesc = beautifyJson(trace.description);
            const beautifiedExtra = beautifyJson(trace.extra || '{}');

            return `
                <div class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <div class="px-6 py-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <span class="bg-blue-50 p-2 rounded-full mr-3"><i class="fa ${traceIcon} ${traceTypeClass}"></i></span>
                                <div>
                                    <h3 class="font-medium text-gray-800">${trace.simpleName || '轨迹信息'}</h3>
                                    <div class="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded-md json-beautify">${beautifiedDesc}</div>
                                </div>
                            </div>
                            <span class="${changeTypeClass} text-xs flex items-center">
                                <i class="fa ${changeTypeIcon} mr-1"></i> ${logChangeType}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 text-sm">
                            <div><span class="text-gray-500">Conversation ID:</span> <span class="font-medium ml-1">${trace.conversationId || '无'}</span></div>
                            <div><span class="text-gray-500">Scene ID:</span> <span class="font-medium ml-1 text-xs break-all">${trace.sceneId || '无'}</span></div>
                            <div><span class="text-gray-500">轨迹类型:</span> <span class="font-medium ${traceTypeClass} ml-1">${trace.traceType || '未知'}</span></div>
                            <div><span class="text-gray-500">请求类型:</span> <span class="font-medium ${requestTypeClass} ml-1">${trace.requestType || '未知'}</span></div>
                            <div><span class="text-gray-500">时间戳:</span> <span class="font-medium ml-1">${formattedTime}</span></div>
                        </div>
                        ${trace.extra ? `
                        <div class="mt-4 text-sm">
                            <span class="text-gray-500 block mb-2">扩展信息:</span>
                            <div class="bg-gray-50 p-3 rounded-md border border-gray-200 text-sm json-beautify">
                                ${beautifiedExtra}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 消息信息卡片
        if (log.messageWrapper) {
            const message = log.messageWrapper;
            const messageTypeClass = message.messageType === 'USER' ? 'text-messageUser' :
                message.messageType === 'TOOL' ? 'text-messageTool' :
                    message.messageType === 'ASSISTANT' ? 'text-messageAssistant' : 'text-messageSystem';

            const messageTypeText = message.messageType === 'USER' ? '用户消息' :
                message.messageType === 'TOOL' ? '工具消息' :
                    message.messageType === 'ASSISTANT' ? '助手消息' : '系统消息';

            const formattedTime = typeof message.time === 'number'
                ? new Date(message.time).toLocaleString()
                : message.time || new Date().toLocaleString();

            // 美化消息内容
            const beautifiedText = beautifyJson(message.text || message.toolCalls || message.responses || '{}');

            return `
                <div class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <div class="px-6 py-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <span class="bg-green-50 p-2 rounded-full mr-3">
                                    <i class="fa fa-comment ${messageTypeClass}"></i>
                                </span>
                                <div>
                                    <h3 class="font-medium text-gray-800">${messageTypeText}</h3>
                                </div>
                            </div>
                            <span class="${changeTypeClass} text-xs flex items-center">
                                <i class="fa ${changeTypeIcon} mr-1"></i> ${logChangeType}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 text-sm">
                            <div><span class="text-gray-500">Conversation ID:</span> <span class="font-medium ml-1">${message.conversationId || '无'}</span></div>
                            <div><span class="text-gray-500">Scene ID:</span> <span class="font-medium ml-1 text-xs break-all">${message.sceneId || '无'}</span></div>
                            <div><span class="text-gray-500">消息类型:</span> <span class="font-medium ${messageTypeClass} ml-1">${message.messageType || '未知'}</span></div>
                            <div><span class="text-gray-500">时间戳:</span> <span class="font-medium ml-1">${formattedTime}</span></div>
                        </div>
                        <div class="mt-4 text-sm">
                            <span class="text-gray-500 block mb-2">消息内容:</span>
                            <div class="bg-gray-50 p-3 rounded-md border border-gray-200 text-sm json-beautify">
                                ${beautifiedText}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 默认卡片（未知类型）
        return `
            <div class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                <div class="px-6 py-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                            <span class="bg-gray-50 p-2 rounded-full mr-3"><i class="fa fa-question-circle text-gray-500"></i></span>
                            <div>
                                <h3 class="font-medium text-gray-800">未知类型</h3>
                            </div>
                        </div>
                        <span class="${changeTypeClass} text-xs flex items-center">
                            <i class="fa ${changeTypeIcon} mr-1"></i> ${logChangeType || '未知'}
                        </span>
                    </div>
                    <div class="mt-4 text-sm">
                        <span class="text-gray-500 block mb-2">原始数据:</span>
                        <div class="bg-gray-50 p-3 rounded-md border border-gray-200 text-sm json-beautify">
                            ${beautifyJson(log)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
</script>
</body>
</html>